<!-- Chat Room -->
<div class="max-w-lg md:max-w-2xl lg:max-w-3xl mx-auto h-[calc(100vh-4rem)] md:h-[calc(100vh-5rem)] flex flex-col">
  <!-- Chat Header -->
  <div class="bg-white border-b border-gray-100 px-4 py-3 flex items-center justify-between z-10 shadow-sm">
    <div class="flex items-center gap-3">
      <%= link_to chat_rooms_path, class: "text-gray-400 hover:text-sky-500 transition-colors p-1" do %>
        <i class="fa-solid fa-arrow-left"></i>
      <% end %>
      <div class="relative">
        <div class="w-10 h-10 rounded-full overflow-hidden ring-2 ring-gray-50">
          <% if @chat_room.is_ai_mode? %>
            <div class="w-full h-full bg-amber-500 flex items-center justify-center">
              <i class="fa-solid fa-robot text-white"></i>
            </div>
          <% else %>
            <img src="https://api.dicebear.com/9.x/shapes/svg?seed=buddy<%= @chat_room.id %>&backgroundColor=e0e7ff" alt="avatar" class="w-full h-full object-cover">
          <% end %>
        </div>
        <% unless @chat_room.is_ai_mode? %>
          <div class="status-online absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 bg-green-400 rounded-full ring-2 ring-white"></div>
        <% end %>
      </div>
      <div>
        <h2 class="font-semibold text-gray-800 text-sm md:text-base">
          <%= @chat_room.is_ai_mode? ? 'AI ติวเตอร์' : 'เพื่อนติวปริศนา' %>
        </h2>
        <p class="text-[10px] text-gray-400">
          <% if @chat_room.is_ai_mode? %>
            <i class="fa-solid fa-wand-magic-sparkles text-sky-400 mr-1"></i>Powered by Gemini AI
          <% else %>
            <span class="text-green-500 flex items-center gap-0.5">
              <span class="w-1.5 h-1.5 bg-green-400 rounded-full inline-block"></span>
              กำลังออนไลน์
            </span>
          <% end %>
        </p>
      </div>
    </div>

    <% unless @chat_room.is_ai_mode? %>
      <button class="px-3 py-1.5 bg-gray-50 hover:bg-sky-50 text-gray-500 hover:text-sky-600 rounded-lg text-xs font-medium transition-colors border border-gray-200 flex items-center gap-1.5" onclick="Swal.fire({title:'เปิดเผยตัวตน?',text:'คู่สนทนาจะเห็นชื่อและรูปโปรไฟล์จริงของคุณ',icon:'warning',showCancelButton:true,confirmButtonText:'ยืนยัน',cancelButtonText:'ยกเลิก',confirmButtonColor:'#0ea5e9'})">
        <i class="fa-solid fa-eye"></i>
        เปิดเผย
      </button>
    <% end %>
  </div>

  <!-- Messages Container -->
  <div class="flex-1 bg-gray-50 overflow-y-auto no-scrollbar px-4 py-4" id="messages-container">
    <!-- Welcome message -->
    <% if @messages.empty? %>
      <div class="text-center py-16 animate-fade-in-up">
        <% if @chat_room.is_ai_mode? %>
          <div class="w-16 h-16 mx-auto bg-amber-500 rounded-full flex items-center justify-center mb-4 shadow-lg shadow-amber-500/20 animate-float">
            <i class="fa-solid fa-robot text-white text-2xl"></i>
          </div>
          <h3 class="font-semibold text-gray-700 text-sm mb-1">สวัสดีครับ! ผมเป็น AI ติวเตอร์</h3>
          <p class="text-gray-400 text-xs max-w-xs mx-auto">ถามอะไรก็ได้เกี่ยวกับการเรียน ผมพร้อมช่วยตลอดเวลา</p>
        <% else %>
          <div class="w-16 h-16 mx-auto bg-indigo-500 rounded-full flex items-center justify-center mb-4 shadow-lg shadow-indigo-500/20 animate-float">
            <i class="fa-solid fa-hand-peace text-white text-2xl"></i>
          </div>
          <h3 class="font-semibold text-gray-700 text-sm mb-1">เริ่มสนทนากันเลย!</h3>
          <p class="text-gray-400 text-xs">ทักทายเพื่อนติวปริศนาของคุณ</p>
        <% end %>
      </div>
    <% end %>

    <div id="messages" class="space-y-3">
      <% @messages.each do |message| %>
        <%= render partial: "messages/message", locals: { message: message } %>
      <% end %>
    </div>
  </div>

  <!-- Turbo Stream Subscription -->
  <%= turbo_stream_from "chat_room_#{@chat_room.id}" %>

  <!-- Message Form -->
  <div class="bg-white border-t border-gray-100 px-4 py-3 safe-area-bottom shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.03)]">
    <div id="message_form">
      <%= render partial: "messages/form", locals: { chat_room: @chat_room, message: @message } %>
    </div>
  </div>
</div>

<script>
  const container = document.getElementById('messages-container');
  if (container) {
    container.scrollTop = container.scrollHeight;
    const observer = new MutationObserver(() => {
      container.scrollTop = container.scrollHeight;
    });
    const messages = document.getElementById('messages');
    if (messages) {
      observer.observe(messages, { childList: true });
    }
  }
</script>
