<!-- Chat List Page -->
<div class="max-w-lg md:max-w-2xl lg:max-w-3xl mx-auto px-4 md:px-6 py-6">
  <div class="animate-fade-in-up">
    <!-- Header -->
    <div class="flex justify-between items-center mb-5">
      <h1 class="text-lg md:text-xl font-bold text-gray-800 dark:text-gray-100 flex items-center gap-2">
        <i class="fa-solid fa-comment text-sky-500"></i>
        แชท
      </h1>
      <%= link_to create_ai_chat_path, method: :post, class: "px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-xl text-xs font-medium transition-all flex items-center gap-1.5 shadow-sm active:scale-95", data: { turbo_method: :post } do %>
        <i class="fa-solid fa-robot"></i>
        เปิดห้อง AI
      <% end %>
    </div>

    <% if @chat_rooms.any? %>
      <div class="grid md:grid-cols-2 gap-3">
        <% @chat_rooms.each do |room| %>
          <% other = room.is_ai_mode? ? nil : room.other_member(current_user) %>
          <% revealed = other && room.identity_revealed?(other) %>
          <% membership = room.chat_room_memberships.find_by(user: current_user) %>
          <% last_read = membership&.last_read_at || membership&.created_at %>
          <% unread = last_read ? room.messages.where("created_at > ? AND (user_id != ? OR user_id IS NULL)", last_read, current_user.id).count : 0 %>
          <%= link_to chat_room_path(room), class: "block bg-white dark:bg-slate-800 rounded-xl border border-gray-100 dark:border-slate-700 shadow-sm p-4 hover:border-sky-200 dark:hover:border-sky-600 hover:shadow-md transition-all duration-200 group" do %>
            <div class="flex items-center gap-3">
              <!-- Avatar -->
              <div class="relative flex-shrink-0">
                <div class="w-12 h-12 rounded-full overflow-hidden ring-2 ring-gray-50 dark:ring-slate-600">
                  <% if room.is_ai_mode? %>
                    <div class="w-full h-full bg-amber-500 flex items-center justify-center">
                      <i class="fa-solid fa-robot text-white text-lg"></i>
                    </div>
                  <% elsif revealed %>
                    <img src="https://api.dicebear.com/9.x/adventurer/svg?seed=<%= other.name %>&backgroundColor=b6e3f4" alt="avatar" class="w-full h-full object-cover">
                  <% else %>
                    <img src="https://api.dicebear.com/9.x/shapes/svg?seed=buddy<%= room.id %>&backgroundColor=e0e7ff" alt="avatar" class="w-full h-full object-cover">
                  <% end %>
                </div>
                <% unless room.is_ai_mode? %>
                  <% if other&.online? %>
                    <div class="status-online absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-400 border-2 border-white dark:border-slate-800 rounded-full"></div>
                  <% else %>
                    <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-gray-300 border-2 border-white dark:border-slate-800 rounded-full"></div>
                  <% end %>
                <% end %>
              </div>

              <!-- Content -->
              <div class="flex-1 min-w-0">
                <div class="flex justify-between items-baseline">
                  <h3 class="font-semibold text-gray-800 dark:text-gray-100 text-sm group-hover:text-sky-500 transition-colors truncate">
                    <%= room.is_ai_mode? ? 'AI ติวเตอร์' : (revealed ? other.name : 'เพื่อนติวปริศนา') %>
                  </h3>
                  <% if room.last_message %>
                    <span class="text-[10px] text-gray-400 whitespace-nowrap ml-2"><%= time_ago_in_words(room.last_message.created_at) %></span>
                  <% end %>
                </div>
                <p class="text-xs text-gray-400 truncate mt-0.5">
                  <% if room.last_message %>
                    <%= room.last_message.content.truncate(45) %>
                  <% else %>
                    <span class="italic">ยังไม่มีข้อความ — ทักเลย!</span>
                  <% end %>
                </p>
              </div>

              <!-- Badge: AI or Unread count -->
              <% if room.is_ai_mode? %>
                <span class="text-[10px] bg-amber-50 text-amber-600 px-2 py-0.5 rounded-md font-medium border border-amber-200 whitespace-nowrap">AI</span>
              <% elsif unread > 0 %>
                <span class="min-w-[20px] h-5 flex items-center justify-center bg-sky-500 text-white text-[10px] font-bold rounded-full px-1.5"><%= unread > 99 ? '99+' : unread %></span>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <!-- Empty State -->
      <div class="bg-white dark:bg-slate-800 rounded-2xl border border-gray-100 dark:border-slate-700 shadow-sm p-12 text-center mt-4">
        <div class="w-20 h-20 bg-gray-100 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-5 animate-float">
          <i class="fa-solid fa-ghost text-gray-300 dark:text-gray-500 text-3xl"></i>
        </div>
        <h3 class="font-semibold text-gray-700 dark:text-gray-200 mb-2">ยังไม่มีห้องแชท</h3>
        <p class="text-gray-400 text-sm mb-6">ไปหาเพื่อนคุยกันเถอะ!</p>
        <div class="flex flex-col sm:flex-row gap-2 sm:justify-center">
          <%= link_to matches_path, class: "w-full sm:w-auto py-3 sm:px-6 bg-sky-500 hover:bg-sky-600 text-white rounded-xl text-sm font-medium transition-colors text-center flex items-center justify-center gap-2 shadow-sm" do %>
            <i class="fa-solid fa-magnifying-glass"></i>
            ค้นหาเพื่อนติว
          <% end %>
          <%= link_to create_ai_chat_path, method: :post, class: "w-full sm:w-auto py-3 sm:px-6 bg-amber-500 hover:bg-amber-600 text-white rounded-xl text-sm font-medium transition-colors text-center flex items-center justify-center gap-2 shadow-sm", data: { turbo_method: :post } do %>
            <i class="fa-solid fa-robot"></i>
            คุยกับ AI
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>
